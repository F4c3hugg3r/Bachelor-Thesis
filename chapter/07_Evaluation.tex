% !TEX root = ../Thesis.tex
%%
%%  Hochschule für Technik und Wirtschaft Berlin --  Abschlussarbeit
%%
%% Kapitel 7 Fazit und Ausblick
%%
%%

\chapter{Evaluation und Ausblick} \label{Evaluation}

In diesem Kapitel werden die in der Testumgebung ermittelten Messergebnisse vorgestellt, analysiert und diskutiert. Ziel ist es, 
die Leistungsfähigkeit des implementierten Rust-Scanners im Vergleich zu etablierten Tools zu bewerten und die Erfüllung der 
definierten Anforderungen zu überprüfen. Abschließend wird ein Ausblick auf mögliche Weiterentwicklungen gegeben.

\section{Darstellung und Reproduzierbarkeit der Messergebnisse}
Die Messergebnisse wurden mittels der in \ref{Versuchsablauf.Datenaufbereitung} beschriebenen Skripte aufbereitet und stehen im Anhang zur
Verfügung. Im Folgenden wird nur auf die ausschlaggebenden Ergebnisse eingegangen. Für jede Messung liegen allerdings umfangreiche
Daten, sowie Diagramme und Tabellen im bereitgestellten GitHub Repository \ref{TODO} zur Verfügung. Der Ablauf, inklusive Erhebung und konkrete
Parameter, sowie die Ausgaben der Tests lässt sich dort unter logs\_benchmark\_suite.txt anhand der Ein- und Ausgaben im Terminal nachvollziehen. 
Mittels dessen und der README.md Datei können die Benchmarks exakt reproduziert und nachvollzogen werden. 

% TODO add citations 
\subsection{Ergebnisse S-01: Anforderungsvalidierung}
Gemäß \ref{Versuchsablauf.Datenaufbereitung} wurden zwei Tests zur Validierung der Implementationen durchgeführt.
Die Auswertung der Ausgabedateien der Scanner zeigt, dass von den 2048 Antworten auf die 4096 gesendeten Paketen, wie geplant 
alle korrekt empfangen und validiert wurden\cite{TODO}. Die \eng{Logs} des Ziel-Knotens bestätigen dies. Dort ist zu sehen, dass
jeweils genau 4096 valide SYN-Pakete angekommen, 2048 Antworten verschickt und 2048 RST-Antworten erhalten wurden\cite{TODO}.  

Beim zweiten Test legten ebenfalls alle Variationen das gleiche Verhalten an den Tag. Die folgenden Informationen verbildlichen also 
stellvertretend die Ergebnisse aller Konfigurationen. In der Ausgabe capture\_no\_rst.pcap des xdpdump Tools des Ziel-Knotens ist 
zu sehen\footnote{Um nur die relevanten Pakete in der Wireshark Ausgabe zu sehen, kann in die Filter-Eingabe \enquote{tcp} eingegebenen werden.}, 
dass vier valide SYN-Pakete beim Ziel-Knoten angekommen sind und daraufhin vier SYN-ACK-Antworten zurückgeschickt wurden. 
Im Kontrast dazu ist in capture\_with\_rst.pcap zu sehen, dass bei der aktivierten
Reset-Funktion auch vier SYN-Pakete eingegangen aber lediglich zwei SYN-Ack-Antworten verschickt und zwei RST-Pakete erhalten wurden. 
Die Ausgaben von xdpdump im Scanner-Knotens zeigen, dass in xdpdump\_no\_rst.pcap vier valide SYN-ACK-Antworten eingingen und in 
xdpdump\_with\_rst.pcap lediglich zwei davon. 

\subsection{Ergebnisse S-02: Performanzgrenzen} \label{Ergebnisse.S-02}
% Um Datei aus dem Repo zu referenzieren: "erschließen sich, unter Anwendung der Auswertungsskripte \texttt{calc_efficiency.py} und \texttt{validate.py} \cite{BachelorRepo}"
% Möglicherweise Permalink nutzen https://github.com/F4c3hugg3r/SYN-Rust/tree/9b948d456828c4e8160d2835728fde6f43a3b75c/scanner
Gemäß \ref{Versuchsablauf.Datenaufbereitung}
wird in \textit{Aktiv} (Zeitraum während Paketfluss besteht) und \textit{Gesamt} (Gesamte Laufzeit des Programmes)
unterschieden. \textit{Netto} beschreibt dabei, dass die Werte von der Grundlast bereinigt wurden.
Aus den Ergebnissen des Tests zum Szenario \hyperref[req:S-02]{/S-02/} erschließen sich nach [TODO Ergebnisse] und [TODO Validierung] die
in \ref{tab:performance_comparison_rounded} dargestellten Werte. Aufgrund von Einschränkungen durch die eigene \eng{Blacklist} hat ZMap 
weniger IP-Adressen gescannt, weshalb es weniger Ergebnisse hervorbrachte. Außerdem ist zu beachten, dass sowohl Masscan als auch ZMap 
keine Option zur Vermeidung des Sendens von RST-Antworten besitzen. Da Masscan die Pakete in dessen eigens gefertigtem Userspace-TCP-Stack
erstellt und versendet, fließen diese auch in die PPS Metrik ein. Die durch ZMap bedingten RST-Antworten werden automatisch vom Kernel 
gesendet und nicht in den genutzten Kernel-Logs erfasst. 

\begin{table}[htbp]
\label{tab:performance_comparison_rounded}
\centering
\small
\begin{tabularx}{\textwidth}{|X|r|r|r|r|r|r|}\hline 
\textbf{Scanner} & \textbf{PPS} & \multicolumn{2}{c|}{\textbf{Netto (Aktiv)}} & \multicolumn{2}{c|}{\textbf{Netto (Gesamt)}} & \textbf{Ergebnisse} \\ 
& \scriptsize{(aktiv) [Mio]} & \scriptsize{CPU [\%]} & \scriptsize{RAM [MB]} & \scriptsize{CPU [\%]} & \scriptsize{RAM [MB]} & \scriptsize{[Mio]} \\ \hline

SYN-Rust \newline \scriptsize{(XDP, Zero-Copy)} & 
 1,48 & 5,7 & 190,8 & 4,7 & 160,7 & 13,42\\ \hline

SYN-Rust \newline \scriptsize{(XDP, Copy)} & 
1,23 & 9,2 & 237,7 & 7,7 & 203,7 & 13,42 \\ \hline

SYN-Rust \newline \scriptsize{(XDP, Generic)} & 
 1,23 & 10,4 & 263,8 & 8,7 & 231,8 & 13,42 \\ \hline

Masscan & 
 1,05 & 13,5 & 42,6 & 12,3 & 42,1 & 13,42 \\ \hline

SYN-Rust \newline \scriptsize{(AF\_PACKET)} & 
 1,06 & 14,2 & 265,6 & 12,1 & 240,9 & 13,42 \\ \hline

ZMap  & 
 1,35 & 21,1 & 13,0 & 17,8 & 12,4 & 10,07 \\ \hline
\end{tabularx}
\caption{Vergleich der Performance-Metriken}
\end{table}

Zur Berechnung der in \ref{fig:performance_efficiency_diag} gezeigten Werte zur Effizienz der Scanner während der aktiven Phase, wurde der Durchsatz 
pro CPU-Prozent in jedem Durchlauf berechnet und daraus anschließend der Durchschnittswert gebildet. 

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\textwidth]{pictures/vergleich_balken_4_effizienz.png}
	\caption{Effizienz der SYN-Scanner im Benchmark (aktiv)}
	\label{fig:performance_efficiency_diag}
\end{figure}
% TODO Namen größer und steiler nach unten

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\textwidth]{pictures/vergleich_balken_2b_cpu_total_gesamt.png}
	\caption{CPU-Auslastung der SYN-Scanner im Benchmark (gesamt)}
	\label{fig:cpu_efficiency_diag}
\end{figure}

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\textwidth]{pictures/vergleich_zeitreihe_3_ram.png}
	\caption{Effizienz der SYN-Scanner im Benchmark (gesamt)}
	\label{fig:ram_efficiency_diag}
\end{figure}

\subsection{Ergebnisse S-03: Reales Szenario}
Die Ergebnisse mancher Variationen des SYN-Rust in der Tabelle \ref{tab:performance_comparison_low_rate_efficiency} weichen bezüglich der PPS Metrik 
von der Durchsatzlimitierung  (500.000 PPS) ab. Dies ist in diesem Szenario \hyperref[req:S-03]{/S-03/} explizit erwünscht. Die Daten der Tabelleneinträge
sind in [TODO Ergebnisse] und [TODO Validierung] zu finden. Für ZMap gilt bezüglich der RST-Antworten das gleiche wie auch in \ref{Ergebnisse.S-02}.  

\begin{table}[htbp]
\label{tab:performance_comparison_low_rate_efficiency}
\centering
\small
\begin{tabularx}{\textwidth}{|X|r|r|r|r|r|r|r|}\hline 
\textbf{Scanner} & \textbf{Effizienz} & \textbf{PPS} & \multicolumn{2}{c|}{\textbf{Netto (Aktiv)}} & \multicolumn{2}{c|}{\textbf{Netto (Gesamt)}} & \textbf{Erg.} \\ 
 & \scriptsize{[PPS/\%]} & \scriptsize{(aktiv) [Mio]} & \scriptsize{CPU [\%]} & \scriptsize{RAM [MB]} & \scriptsize{CPU [\%]} & \scriptsize{RAM [MB]} & \scriptsize{[Mio]} \\ \hline

SYN-Rust \newline \scriptsize{(XDP, Zero-Copy,}  \newline \scriptsize{kein RST)} & 
 184353 & 0,51 & 2,8 & 82,2 & 1,8 & 62,0 & 1,64 \\ \hline

SYN-Rust \newline \scriptsize{(XDP, Copy)} & 
 106118 & 0,60 & 5,7 & 77,0 & 3,6 & 57,7 & 1,64 \\ \hline

SYN-Rust \newline \scriptsize{(XDP, Generic)} & 
 103087 & 0,60 & 5,9 & 96,9 & 3,7 & 74,7 & 1,64 \\ \hline

SYN-Rust \newline \scriptsize{(AF\_PACKET)} & 
 99871 & 0,61 & 6,1 & 112,2 & 3,8 & 88,3 & 1,64 \\ \hline

Masscan \newline \scriptsize{(ohne Deduplizierung,}  \newline \scriptsize{RST automatisch)} & 
 75534 & 0,60 & 6,6 & 34,8 & 4,8 & 31,4 & 1,68 \\ \hline

ZMap  \newline \scriptsize{(RST automatisch)} & 
 13272 & 0,59 & 37,2 & 62,3 & 26,5 & 58,3 & 1,68 \\ \hline

\end{tabularx}
\caption{Vergleich der Performance-Metriken (Unter Berücksichtigung der RST-Pakete)}
\end{table}

\section{Diskussion der Ergebnisse}
% Hier interpretieren Sie die Zahlen aus 7.1.

\subsection{Performance}
% Warum ist XDP schneller als AF_PACKET?
% Wo liegen die Flaschenhälse (CPU, PCIe-Bus, Kernel)?

\subsection{Ressourceneffizienz}
% Bezug auf Anforderung /M-02/ und /M-03/.
% Vergleich Rust vs. C (ZMap/Masscan).
% Diskussion des Overheads durch Tokio/Async vs. Threading.

\section{Abgleich mit den Anforderungen}
% Gehen Sie die Liste aus Kap. 4 durch (/F-01/ bis /F-09/ und /NF-xx/).
% Eine Tabelle eignet sich hier gut (Anforderung | Status | Bemerkung).

\section{Ausblick}
% Was konnte in dieser Arbeit nicht umgesetzt werden?
% Ideen: IPv6 Support, Distributed Scanning, GUI, Output-Module (JSON/Redis).

\section{Fazit}
% Zusammenfassung der gesamten Arbeit.
% Forschungsfrage beantworten: Ist Rust/eBPF geeignet für High-Speed Scanning?